name: Build Yoga

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-yoga:
    name: Build Yoga (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-15, windows-latest]

    env:
      CMAKE_BUILD_PARALLEL_LEVEL: 4
      YOGA_REPO: https://github.com/facebook/yoga
      YOGA_SRC_DIR: yoga
      YOGA_BUILD_DIR: yoga/build
      OS_NAME: ${{ matrix.os }}

    steps:
      - name: Checkout yogapy
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install CMake (Windows only)
        if: matrix.os == 'windows-latest'
        uses: lukka/get-cmake@latest
        with:
          useCloudCache: true
          useLocalCache: false

      - name: Clone Yoga
        run: |
          git clone --depth 1 "$YOGA_REPO" "$YOGA_SRC_DIR"

      # ---------- Configure ----------

      - name: Configure Yoga (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          cd "$YOGA_SRC_DIR"
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DYOGA_BUILD_SHARED=ON \
            -DYOGA_BUILD_TESTS=OFF \
            -DYOGA_BUILD_BENCHMARKS=OFF \
            -DYOGA_BUILD_TOOLS=OFF

      - name: Configure Yoga (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd $env:YOGA_SRC_DIR
          cmake -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_SHARED_LIBS=ON `
            -DYOGA_BUILD_SHARED=ON `
            -DYOGA_BUILD_TESTS=OFF `
            -DYOGA_BUILD_BENCHMARKS=OFF `
            -DYOGA_BUILD_TOOLS=OFF

      # ---------- Build ----------

      - name: Build Yoga (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          cd "$YOGA_SRC_DIR"
          cmake --build build --config Release

      - name: Build Yoga (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd $env:YOGA_SRC_DIR
          cmake --build build --config Release -- /m

      # ---------- Collect artifacts ----------

      - name: Collect Yoga shared library
        shell: bash
        run: |
          mkdir -p yoga-artifacts

          if [ "$OS_NAME" = "ubuntu-latest" ]; then
            # CMake puts shared libs under build/lib on Unix
            cp "$YOGA_BUILD_DIR/lib/libyoga.so" yoga-artifacts/
          elif [ "$OS_NAME" = "macos-15" ]; then
            # Fix: correct path is build/lib/libyoga.dylib, not build/libyoga.dylib
            cp "$YOGA_BUILD_DIR/lib/libyoga.dylib" yoga-artifacts/
          else
            # Visual Studio generator: DLLs under build/Release
            cp "$YOGA_BUILD_DIR/Release/yoga.dll" yoga-artifacts/
          fi

      - name: Upload Yoga artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yoga-${{ matrix.os }}
          path: yoga-artifacts/
          if-no-files-found: error
